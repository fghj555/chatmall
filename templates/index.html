<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChatMall - AI Shopping Assistant</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(120deg, #f6f7f9, #dfe9f3);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            width: 100%;
            max-width: 800px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 15px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #1877f2, #42b883);
            color: white;
            padding: 20px;
            text-align: center;
            font-size: 24px;
            font-weight: bold;
        }

        .content {
            padding: 30px;
        }

        .search-section {
            margin-bottom: 30px;
        }

        .search-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 25px;
            font-size: 16px;
            outline: none;
            transition: border-color 0.3s ease;
        }

        .search-input:focus {
            border-color: #1877f2;
        }

        .search-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #1877f2, #42b883);
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 15px;
            transition: transform 0.2s ease;
        }

        .search-btn:hover {
            transform: translateY(-2px);
        }

        .search-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .results-section {
            display: none;
            margin-top: 30px;
        }

        .ai-message {
            background: #e7f3ff;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #1877f2;
        }

        .product-grid {
            display: grid;
            gap: 20px;
        }

        .product-card {
            border: 2px solid #eee;
            border-radius: 15px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .product-card:hover {
            border-color: #1877f2;
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }

        .product-card.selected {
            border-color: #42b883;
            background: #f0fff4;
        }

        .product-image {
            width: 120px;
            height: 120px;
            object-fit: cover;
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .product-name {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
        }

        .product-price {
            font-size: 16px;
            color: #1877f2;
            font-weight: bold;
        }

        .order-section {
            display: none;
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 15px;
        }

        .order-step {
            margin-bottom: 25px;
        }

        .step-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
        }

        .options-grid {
            display: grid;
            gap: 10px;
        }

        .option-item {
            padding: 12px 15px;
            background: white;
            border: 2px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .option-item:hover {
            border-color: #1877f2;
        }

        .option-item.selected {
            border-color: #42b883 !important;
            background: #e8f5e8 !important;
            color: #2d5a2d;
            font-weight: bold;
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(66, 184, 131, 0.3);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }

        .form-input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: #1877f2;
        }

        .quantity-input {
            width: 100px;
            text-align: center;
        }

        .price-summary {
            background: #e7f3ff;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .price-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .total-price {
            font-size: 18px;
            font-weight: bold;
            color: #1877f2;
            border-top: 2px solid #ddd;
            padding-top: 10px;
            margin-top: 10px;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 5px;
        }

        .btn-primary {
            background: #1877f2;
            color: white;
        }

        .btn-primary:hover {
            background: #166fe5;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #1877f2;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none !important;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 15px;
            }
            
            .content {
                padding: 20px;
            }
            
            .header {
                font-size: 20px;
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            ğŸ›ï¸ ChatMall AI Shopping Assistant
        </div>
        
        <div class="content">
            <!-- ê²€ìƒ‰ ì„¹ì…˜ -->
            <div class="search-section">
                <input 
                    type="text" 
                    id="searchInput" 
                    class="search-input" 
                    placeholder="ì°¾ê³  ì‹¶ì€ ìƒí’ˆì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: ë¬´ì„  ì´ì–´í°, ì—¬ë¦„ ì›í”¼ìŠ¤)"
                    onkeypress="handleEnterKey(event)"
                >
                <button id="searchBtn" class="search-btn" onclick="searchProducts()">
                    ğŸ” AI ìƒí’ˆ ê²€ìƒ‰
                </button>
            </div>

            <!-- ê²€ìƒ‰ ê²°ê³¼ ì„¹ì…˜ -->
            <div id="resultsSection" class="results-section">
                <div id="aiMessage" class="ai-message"></div>
                <div id="productGrid" class="product-grid"></div>
            </div>

            <!-- ì£¼ë¬¸ ì„¹ì…˜ -->
            <div id="orderSection" class="order-section">
                <!-- ì˜µì…˜ ì„ íƒ -->
                <div id="optionStep" class="order-step hidden">
                    <div class="step-title">âš™ï¸ ì˜µì…˜ ì„ íƒ</div>
                    <div id="optionsGrid" class="options-grid"></div>
                    <button class="btn btn-primary" onclick="skipOptions()" id="skipOptionsBtn" style="display: none;">
                        ì˜µì…˜ ì—†ì´ ì§„í–‰
                    </button>
                </div>

                <!-- ìˆ˜ëŸ‰ ì„ íƒ -->
                <div id="quantityStep" class="order-step hidden">
                    <div class="step-title">ğŸ”¢ ìˆ˜ëŸ‰ ì„ íƒ</div>
                    <div class="form-group">
                        <label class="form-label">ìˆ˜ëŸ‰:</label>
                        <input type="number" id="quantityInput" class="form-input quantity-input" value="1" min="1" onchange="calculatePrice()">
                        <div id="quantityInfo" style="margin-top: 10px; color: #666; font-size: 14px;"></div>
                    </div>
                    <div id="priceSummary" class="price-summary"></div>
                    <button class="btn btn-primary" onclick="confirmQuantity()">ì£¼ë¬¸ ì •ë³´ ì…ë ¥í•˜ê¸°</button>
                </div>

                <!-- ì£¼ë¬¸ì ì •ë³´ -->
                <div id="infoStep" class="order-step hidden">
                    <div class="step-title">ğŸ“ ì£¼ë¬¸ì ì •ë³´</div>
                    <div class="form-group">
                        <label class="form-label">ìˆ˜ë ¹ì¸ ì´ë¦„:</label>
                        <input type="text" id="receiverName" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">ë°°ì†¡ ì£¼ì†Œ:</label>
                        <textarea id="address" class="form-input" rows="3" required></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">ì—°ë½ì²˜:</label>
                        <input type="tel" id="phoneNumber" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">ì´ë©”ì¼:</label>
                        <input type="email" id="email" class="form-input" required>
                    </div>
                    <button class="btn btn-success" onclick="submitOrderInfo()">ì£¼ë¬¸ í™•ì¸í•˜ê¸°</button>
                </div>

                <!-- ìµœì¢… í™•ì¸ -->
                <div id="finalStep" class="order-step hidden">
                    <div class="step-title">âœ… ìµœì¢… ì£¼ë¬¸ í™•ì¸</div>
                    <div id="finalSummary"></div>
                    <div class="alert alert-success">
                        <strong>ğŸ’³ ê²°ì œ ì•ˆë‚´:</strong><br>
                        í•˜ë‚˜ì€í–‰ 841-910015-85404 (ì£¼)ë‚˜ë¡œìˆ˜<br>
                        ì…ê¸ˆ í›„ ì•„ë˜ ë²„íŠ¼ì„ í´ë¦­í•´ì£¼ì„¸ìš”.
                    </div>
                    <button class="btn btn-success" onclick="completeOrder()">ğŸ‰ ì£¼ë¬¸ ì™„ë£Œ</button>
                </div>

                <!-- ì™„ë£Œ -->
                <div id="completedStep" class="order-step hidden">
                    <div class="step-title">ğŸ‰ ì£¼ë¬¸ ì™„ë£Œ</div>
                    <div id="completionMessage"></div>
                    <button class="btn btn-primary" onclick="startNewOrder()">ìƒˆ ì£¼ë¬¸ ì‹œì‘</button>
                </div>
            </div>

            <!-- ë¡œë”© -->
            <div id="loading" class="loading hidden">
                <div class="spinner"></div>
                <div>ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤...</div>
            </div>
        </div>
    </div>

    <script>
        // ì „ì—­ ë³€ìˆ˜
        let sessionId = null;
        let currentStep = 'search';
        let selectedProduct = null;
        let selectedOption = null;
        let orderData = {};

        // ì„œë²„ í˜¸ìŠ¤íŠ¸
        const getHost = () => {
            return window.location.hostname === "localhost"
                ? "http://localhost:5051"
                : "https://port-0-chatmall2-mddsxz1wc930914e.sel5.cloudtype.app";
        };

        // í†µí•© API í˜¸ì¶œ
        async function callAPI(action, data = {}) {
            try {
                const response = await fetch(`${getHost()}/web/order`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: action,
                        session_id: sessionId,
                        ...data
                    })
                });

                const result = await response.json();
                
                if (result.session_id) {
                    sessionId = result.session_id;
                }

                return result;
            } catch (error) {
                console.error('API í˜¸ì¶œ ì˜¤ë¥˜:', error);
                return { success: false, error: 'ì„œë²„ ì—°ê²° ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' };
            }
        }

        // ì—”í„° í‚¤ ì´ë²¤íŠ¸
        function handleEnterKey(event) {
            if (event.key === 'Enter') {
                searchProducts();
            }
        }

        // ìƒí’ˆ ê²€ìƒ‰
        async function searchProducts() {
            const query = document.getElementById('searchInput').value.trim();
            if (!query) {
                alert('ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!');
                return;
            }

            showLoading(true);
            hideElement('resultsSection');
            hideElement('orderSection');

            const result = await callAPI('search', { query: query });

            showLoading(false);

            if (result.success) {
                displaySearchResults(result);
            } else {
                showAlert(result.error || 'ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        // ê²€ìƒ‰ ê²°ê³¼ í‘œì‹œ
        function displaySearchResults(result) {
            console.log('ê²€ìƒ‰ ê²°ê³¼ í‘œì‹œ:', result);
            
            if (result.message) {
                document.getElementById('aiMessage').textContent = result.message;
            }

            const productGrid = document.getElementById('productGrid');
            productGrid.innerHTML = '';

            if (result.results && result.results.length > 0) {
                result.results.forEach((product, index) => {
                    console.log(`ìƒí’ˆ ${index + 1}:`, product);
                    
                    const productCard = document.createElement('div');
                    productCard.className = 'product-card';
                    productCard.onclick = () => selectProduct(product.ìƒí’ˆì½”ë“œ, index);
                    
                    productCard.innerHTML = `
                        <div class="product-name">${product.ì œëª©}</div>
                        <div class="product-price">ğŸ’° ${parseInt(product.ê°€ê²©).toLocaleString()}ì›</div>
                        <div style="color: #666; margin-top: 5px;">ğŸšš ë°°ì†¡ë¹„: ${parseInt(product.ë°°ì†¡ë¹„).toLocaleString()}ì›</div>
                        <div style="color: #666;">ğŸŒ ì›ì‚°ì§€: ${product.ì›ì‚°ì§€}</div>
                        ${product.ì´ë¯¸ì§€ ? `<img src="${product.ì´ë¯¸ì§€}" alt="ìƒí’ˆ ì´ë¯¸ì§€" class="product-image">` : ''}
                        <button class="btn btn-primary" style="margin-top: 15px; width: 100%;">ì´ ìƒí’ˆ ì£¼ë¬¸í•˜ê¸°</button>
                    `;
                    
                    productGrid.appendChild(productCard);
                });

                // ê²°ê³¼ ì„¹ì…˜ ê°•ì œ í‘œì‹œ
                const resultsSection = document.getElementById('resultsSection');
                resultsSection.style.display = 'block';
                resultsSection.classList.remove('hidden');
                console.log('ê²€ìƒ‰ ê²°ê³¼ ì„¹ì…˜ í‘œì‹œë¨');
            } else {
                document.getElementById('aiMessage').textContent = 'ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤. ë‹¤ë¥¸ í‚¤ì›Œë“œë¡œ ì‹œë„í•´ë³´ì„¸ìš”.';
                const resultsSection = document.getElementById('resultsSection');
                resultsSection.style.display = 'block';
                resultsSection.classList.remove('hidden');
            }
        }

        // ìƒí’ˆ ì„ íƒ
        async function selectProduct(productCode, index) {
            console.log('ìƒí’ˆ ì„ íƒ:', productCode, 'index:', index);
            showLoading(true);

            // ì‹œê°ì  ì„ íƒ í‘œì‹œ
            document.querySelectorAll('.product-card').forEach(card => {
                card.classList.remove('selected');
            });
            if (document.querySelectorAll('.product-card')[index]) {
                document.querySelectorAll('.product-card')[index].classList.add('selected');
            }

            const result = await callAPI('select_product', { product_code: productCode });
            console.log('ğŸ” ìƒí’ˆ ì„ íƒ API ì „ì²´ ì‘ë‹µ:', result);

            showLoading(false);

            if (result.success) {
                selectedProduct = result.product;
                console.log('âœ… ì„ íƒëœ ìƒí’ˆ:', selectedProduct);
                
                // ë””ë²„ê·¸ ì •ë³´ ì¶œë ¥
                if (result.debug_info) {
                    console.log('ğŸ› ë””ë²„ê·¸ ì •ë³´:');
                    console.log('   - ì›ë³¸ ì˜µì…˜ ë°ì´í„°:', result.debug_info.raw_options);
                    console.log('   - íŒŒì‹±ëœ ì˜µì…˜ ìˆ˜:', result.debug_info.parsed_count);
                }
                
                console.log('ğŸ“‹ ë°›ì€ ì˜µì…˜ ëª©ë¡:', result.options);
                console.log('ğŸ“Š ì˜µì…˜ ê°œìˆ˜:', result.options ? result.options.length : 0);
                console.log('ğŸ” ì˜µì…˜ ìˆìŒ ì—¬ë¶€:', result.has_options);
                
                // ì£¼ë¬¸ ì„¹ì…˜ ê°•ì œ í‘œì‹œ
                const orderSection = document.getElementById('orderSection');
                orderSection.style.display = 'block';
                orderSection.classList.remove('hidden');
                console.log('ì£¼ë¬¸ ì„¹ì…˜ í‘œì‹œë¨');

                if (result.has_options && result.options && result.options.length > 0) {
                    console.log('âœ… ì˜µì…˜ì´ ìˆì–´ì„œ ì˜µì…˜ í‘œì‹œ í•¨ìˆ˜ í˜¸ì¶œ');
                    displayOptions(result.options);
                } else {
                    console.log('âš ï¸ ì˜µì…˜ì´ ì—†ì–´ì„œ ë°”ë¡œ ìˆ˜ëŸ‰ ì„ íƒìœ¼ë¡œ');
                    skipOptions();
                }
            } else {
                console.error('âŒ ìƒí’ˆ ì„ íƒ ì‹¤íŒ¨:', result.error);
                showAlert(result.error || 'ìƒí’ˆ ì„ íƒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        // ì˜µì…˜ í‘œì‹œ
        function displayOptions(options) {
            console.log('ğŸ¯ ì˜µì…˜ í‘œì‹œ í•¨ìˆ˜ ì‹œì‘');
            console.log('ğŸ“‹ ë°›ì€ ì˜µì…˜ ë°°ì—´:', options);
            console.log('ğŸ“Š ì˜µì…˜ ë°°ì—´ ê¸¸ì´:', options.length);
            
            // ê° ì˜µì…˜ ìƒì„¸ ì¶œë ¥
            options.forEach((option, index) => {
                console.log(`   ì˜µì…˜ ${index + 1}:`, option);
                console.log(`     - ì´ë¦„: ${option.name}`);
                console.log(`     - ì¶”ê°€ê¸ˆì•¡: ${option.extra_price}`);
                console.log(`     - í‘œì‹œëª…: ${option.display}`);
            });
            
            const optionsGrid = document.getElementById('optionsGrid');
            console.log('ğŸ” ì˜µì…˜ ê·¸ë¦¬ë“œ ìš”ì†Œ:', optionsGrid);
            
            // ê¸°ì¡´ ì˜µì…˜ ì œê±°
            optionsGrid.innerHTML = '';
            console.log('ğŸ§¹ ê¸°ì¡´ ì˜µì…˜ ì œê±° ì™„ë£Œ');

            // ê° ì˜µì…˜ì„ DOMì— ì¶”ê°€
            options.forEach((option, index) => {
                console.log(`ğŸ”¨ ì˜µì…˜ ${index + 1} DOM ìƒì„± ì¤‘: ${option.display}`);
                
                const optionItem = document.createElement('div');
                optionItem.className = 'option-item';
                optionItem.id = `option-${index}`;
                optionItem.textContent = option.display;
                
                // í´ë¦­ ì´ë²¤íŠ¸ ì„¤ì •
                optionItem.onclick = () => {
                    console.log(`ğŸ–±ï¸ ì˜µì…˜ ${index + 1} í´ë¦­ë¨:`, option.name);
                    selectOption(option.name, option.extra_price, index);
                };
                
                // í˜¸ë²„ íš¨ê³¼ ì¶”ê°€
                optionItem.addEventListener('mouseenter', function() {
                    console.log(`ğŸ–±ï¸ ì˜µì…˜ ${index + 1} ë§ˆìš°ìŠ¤ ì§„ì…`);
                    if (!this.classList.contains('selected')) {
                        this.style.borderColor = '#1877f2';
                        this.style.backgroundColor = '#f0f9ff';
                    }
                });
                
                optionItem.addEventListener('mouseleave', function() {
                    if (!this.classList.contains('selected')) {
                        this.style.borderColor = '#ddd';
                        this.style.backgroundColor = 'white';
                    }
                });
                
                optionsGrid.appendChild(optionItem);
                console.log(`âœ… ì˜µì…˜ ${index + 1} DOM ì¶”ê°€ ì™„ë£Œ`);
            });

            console.log('ğŸ¯ ì˜µì…˜ ê·¸ë¦¬ë“œì— ì¶”ê°€ëœ ì´ ì˜µì…˜ ìˆ˜:', optionsGrid.children.length);

            // ì˜µì…˜ ë‹¨ê³„ ê°•ì œ í‘œì‹œ
            const optionStep = document.getElementById('optionStep');
            optionStep.style.display = 'block';
            optionStep.classList.remove('hidden');
            
            const skipBtn = document.getElementById('skipOptionsBtn');
            skipBtn.style.display = 'block';
            
            console.log('âœ… ì˜µì…˜ ë‹¨ê³„ UI í‘œì‹œ ì™„ë£Œ');
            console.log('ğŸ“Š ìµœì¢… ìƒíƒœ:');
            console.log('   - ì˜µì…˜ ë‹¨ê³„ í‘œì‹œë¨:', !optionStep.classList.contains('hidden'));
            console.log('   - ì˜µì…˜ í•­ëª© ìˆ˜:', optionsGrid.children.length);
            console.log('   - ê±´ë„ˆë›°ê¸° ë²„íŠ¼ í‘œì‹œ:', skipBtn.style.display === 'block');
        }

        // ì˜µì…˜ ì„ íƒ
        async function selectOption(optionName, extraPrice, index) {
            console.log('ì˜µì…˜ ì„ íƒ:', optionName, extraPrice, index);
            
            // ì‹œê°ì  ì„ íƒ í‘œì‹œ
            document.querySelectorAll('.option-item').forEach(item => {
                item.classList.remove('selected');
            });
            
            const optionItems = document.querySelectorAll('.option-item');
            if (optionItems[index]) {
                optionItems[index].classList.add('selected');
                console.log('ì˜µì…˜ ì‹œê°ì  ì„ íƒ ì™„ë£Œ');
            }

            // API í˜¸ì¶œ
            const result = await callAPI('select_option', {
                option_name: optionName,
                extra_price: extraPrice
            });

            console.log('ì˜µì…˜ ì„ íƒ API ê²°ê³¼:', result);

            if (result.success) {
                selectedOption = { name: optionName, extra_price: extraPrice };
                console.log('ì˜µì…˜ ì„ íƒ ì„±ê³µ, 1.5ì´ˆ í›„ ìˆ˜ëŸ‰ ë‹¨ê³„ë¡œ ì´ë™');
                
                // ì„ íƒ ì™„ë£Œ ë©”ì‹œì§€ í‘œì‹œ
                showAlert(`âœ… ì˜µì…˜ ì„ íƒ ì™„ë£Œ: ${optionName}`, 'success');
                
                setTimeout(() => {
                    console.log('ì˜µì…˜ ë‹¨ê³„ ìˆ¨ê¸°ê¸°');
                    // ì˜µì…˜ ë‹¨ê³„ ìˆ¨ê¸°ê¸°
                    const optionStep = document.getElementById('optionStep');
                    optionStep.style.display = 'none';
                    optionStep.classList.add('hidden');
                    
                    console.log('ìˆ˜ëŸ‰ ë‹¨ê³„ í‘œì‹œ ì‹œì‘');
                    showQuantityStep();
                }, 1500);
            } else {
                console.error('ì˜µì…˜ ì„ íƒ ì‹¤íŒ¨:', result.error);
                showAlert(result.error || 'ì˜µì…˜ ì„ íƒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        // ì˜µì…˜ ê±´ë„ˆë›°ê¸°
        async function skipOptions() {
            console.log('ì˜µì…˜ ê±´ë„ˆë›°ê¸°');
            
            // ê¸°ë³¸ ì˜µì…˜ìœ¼ë¡œ ì„¤ì •
            const result = await callAPI('select_option', {
                option_name: 'ê¸°ë³¸ì˜µì…˜',
                extra_price: 0
            });

            if (result.success) {
                selectedOption = { name: 'ê¸°ë³¸ì˜µì…˜', extra_price: 0 };
                console.log('ê¸°ë³¸ ì˜µì…˜ ì„¤ì • ì™„ë£Œ');
                
                // ì˜µì…˜ ë‹¨ê³„ ìˆ¨ê¸°ê¸°
                const optionStep = document.getElementById('optionStep');
                optionStep.style.display = 'none';
                optionStep.classList.add('hidden');
                
                showQuantityStep();
            } else {
                // API ì‹¤íŒ¨ì‹œì—ë„ ì§„í–‰ (í´ë¼ì´ì–¸íŠ¸ì—ì„œë§Œ ì²˜ë¦¬)
                selectedOption = { name: 'ê¸°ë³¸ì˜µì…˜', extra_price: 0 };
                console.log('API ì‹¤íŒ¨í–ˆì§€ë§Œ ê¸°ë³¸ ì˜µì…˜ìœ¼ë¡œ ì§„í–‰');
                
                const optionStep = document.getElementById('optionStep');
                optionStep.style.display = 'none';
                optionStep.classList.add('hidden');
                
                showQuantityStep();
            }
        }

        // ìˆ˜ëŸ‰ ì„ íƒ ë‹¨ê³„ í‘œì‹œ
        function showQuantityStep() {
            console.log('ìˆ˜ëŸ‰ ì„ íƒ ë‹¨ê³„ í‘œì‹œ');
            
            // ìˆ˜ëŸ‰ ë‹¨ê³„ ê°•ì œ í‘œì‹œ
            const quantityStep = document.getElementById('quantityStep');
            quantityStep.style.display = 'block';
            quantityStep.classList.remove('hidden');
            
            console.log('ìˆ˜ëŸ‰ ë‹¨ê³„ í‘œì‹œë¨');
            calculatePrice();
        }

        // ê°€ê²© ê³„ì‚°
        async function calculatePrice() {
            const quantity = parseInt(document.getElementById('quantityInput').value) || 1;

            const result = await callAPI('set_quantity', { quantity: quantity });

            if (result.success) {
                const summary = result.order_summary;

                // ìˆ˜ëŸ‰ ì •ë³´ í‘œì‹œ
                let quantityInfo = `ğŸ“¦ ì£¼ë¬¸ ìˆ˜ëŸ‰: ${quantity}ê°œ`;
                if (summary.bundle_size > 0 && summary.bundles_needed > 1) {
                    quantityInfo += `<br>ğŸ“¦ ë¬¶ìŒë°°ì†¡: ${summary.bundle_size}ê°œì”© Ã— ${summary.bundles_needed}ë¬¶ìŒ`;
                }
                document.getElementById('quantityInfo').innerHTML = quantityInfo;

                // ê°€ê²© ìš”ì•½ í‘œì‹œ
                const priceSummary = document.getElementById('priceSummary');
                priceSummary.innerHTML = `
                    <div class="price-row">
                        <span>ìƒí’ˆ ë‹¨ê°€:</span>
                        <span>${summary.unit_price.toLocaleString()}ì›</span>
                    </div>
                    ${summary.extra_price > 0 ? `
                    <div class="price-row">
                        <span>ì˜µì…˜ ì¶”ê°€:</span>
                        <span>+${summary.extra_price.toLocaleString()}ì›</span>
                    </div>` : ''}
                    <div class="price-row">
                        <span>ìƒí’ˆ ì†Œê³„:</span>
                        <span>${summary.item_total.toLocaleString()}ì›</span>
                    </div>
                    <div class="price-row">
                        <span>ë°°ì†¡ë¹„:</span>
                        <span>${summary.shipping_fee.toLocaleString()}ì›</span>
                    </div>
                    <div class="price-row total-price">
                        <span>ì´ ê²°ì œê¸ˆì•¡:</span>
                        <span>${summary.total_price.toLocaleString()}ì›</span>
                    </div>
                `;

                orderData = summary;
            }
        }

        // ìˆ˜ëŸ‰ í™•ì¸
        function confirmQuantity() {
            const quantity = parseInt(document.getElementById('quantityInput').value);
            if (!quantity || quantity < 1) {
                alert('ì˜¬ë°”ë¥¸ ìˆ˜ëŸ‰ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            console.log('ìˆ˜ëŸ‰ í™•ì¸ë¨, ì •ë³´ ì…ë ¥ ë‹¨ê³„ë¡œ ì´ë™');
            
            // ìˆ˜ëŸ‰ ë‹¨ê³„ ìˆ¨ê¸°ê¸°
            const quantityStep = document.getElementById('quantityStep');
            quantityStep.style.display = 'none';
            quantityStep.classList.add('hidden');
            
            // ì •ë³´ ì…ë ¥ ë‹¨ê³„ í‘œì‹œ
            const infoStep = document.getElementById('infoStep');
            infoStep.style.display = 'block';
            infoStep.classList.remove('hidden');
            
            console.log('ì •ë³´ ì…ë ¥ ë‹¨ê³„ í‘œì‹œë¨');
        }

        // ì£¼ë¬¸ì ì •ë³´ ì œì¶œ
        async function submitOrderInfo() {
            const receiverName = document.getElementById('receiverName').value.trim();
            const address = document.getElementById('address').value.trim();
            const phoneNumber = document.getElementById('phoneNumber').value.trim();
            const email = document.getElementById('email').value.trim();

            if (!receiverName || !address || !phoneNumber || !email) {
                alert('ëª¨ë“  í•„ìˆ˜ ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            console.log('ì£¼ë¬¸ì ì •ë³´ ì œì¶œ');
            showLoading(true);

            const result = await callAPI('submit_info', {
                receiver_name: receiverName,
                address: address,
                phone_number: phoneNumber,
                email: email
            });

            console.log('ì£¼ë¬¸ì ì •ë³´ ì œì¶œ ê²°ê³¼:', result);
            showLoading(false);

            if (result.success) {
                // ì •ë³´ ì…ë ¥ ë‹¨ê³„ ìˆ¨ê¸°ê¸°
                const infoStep = document.getElementById('infoStep');
                infoStep.style.display = 'none';
                infoStep.classList.add('hidden');
                
                console.log('ì •ë³´ ì…ë ¥ ì™„ë£Œ, ìµœì¢… ìš”ì•½ìœ¼ë¡œ ì´ë™');
                showFinalSummary();
            } else {
                showAlert(result.error || 'ì£¼ë¬¸ ì •ë³´ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        // ìµœì¢… ìš”ì•½ í‘œì‹œ
        function showFinalSummary() {
            console.log('ìµœì¢… ìš”ì•½ í‘œì‹œ');
            
            const receiverName = document.getElementById('receiverName').value;
            const address = document.getElementById('address').value;

            document.getElementById('finalSummary').innerHTML = `
                <div class="alert alert-success">
                    <strong>ğŸ“‹ ì£¼ë¬¸ ìµœì¢… í™•ì¸:</strong><br><br>
                    <strong>ğŸ‘¤ ìˆ˜ë ¹ì¸:</strong> ${receiverName}<br>
                    <strong>ğŸ“¦ ìƒí’ˆ:</strong> ${selectedProduct.name}<br>
                    <strong>âš™ï¸ ì˜µì…˜:</strong> ${selectedOption.name}<br>
                    <strong>ğŸ”¢ ìˆ˜ëŸ‰:</strong> ${orderData.quantity}ê°œ<br>
                    <strong>ğŸ  ë°°ì†¡ì§€:</strong> ${address}<br><br>
                    <div class="total-price">
                        ğŸ’° ì´ ê²°ì œê¸ˆì•¡: ${orderData.total_price.toLocaleString()}ì›
                    </div>
                </div>
            `;

            // ìµœì¢… ë‹¨ê³„ ê°•ì œ í‘œì‹œ
            const finalStep = document.getElementById('finalStep');
            finalStep.style.display = 'block';
            finalStep.classList.remove('hidden');
            
            console.log('ìµœì¢… ë‹¨ê³„ í‘œì‹œë¨');
        }

        // ì£¼ë¬¸ ì™„ë£Œ
        async function completeOrder() {
            console.log('ì£¼ë¬¸ ì™„ë£Œ ì²˜ë¦¬ ì‹œì‘');
            showLoading(true);

            const result = await callAPI('complete');
            console.log('ì£¼ë¬¸ ì™„ë£Œ ê²°ê³¼:', result);

            showLoading(false);

            if (result.success) {
                // ìµœì¢… ë‹¨ê³„ ìˆ¨ê¸°ê¸°
                const finalStep = document.getElementById('finalStep');
                finalStep.style.display = 'none';
                finalStep.classList.add('hidden');
                
                document.getElementById('completionMessage').innerHTML = `
                    <div class="alert alert-success">
                        <strong>ğŸ‰ ì£¼ë¬¸ì´ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!</strong><br><br>
                        <strong>ğŸ“‹ ì£¼ë¬¸ë²ˆí˜¸:</strong> ${result.order_number}<br>
                        <strong>â° ì£¼ë¬¸ì‹œê°„:</strong> ${result.order_details.timestamp}<br>
                        <strong>ğŸ’° ê²°ì œê¸ˆì•¡:</strong> ${result.order_details.total_price.toLocaleString()}ì›<br><br>
                        ğŸ’³ ì…ê¸ˆ í™•ì¸ í›„ ìƒí’ˆ ì¤€ë¹„ì— ë“¤ì–´ê°‘ë‹ˆë‹¤.</p>
                    </div>
                `;

                // ì™„ë£Œ ë‹¨ê³„ í‘œì‹œ
                const completedStep = document.getElementById('completedStep');
                completedStep.style.display = 'block';
                completedStep.classList.remove('hidden');
                
                console.log('ì£¼ë¬¸ ì™„ë£Œ ë‹¨ê³„ í‘œì‹œë¨');
            } else {
                showAlert(result.error || 'ì£¼ë¬¸ ì™„ë£Œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        // ìƒˆ ì£¼ë¬¸ ì‹œì‘
        async function startNewOrder() {
            await callAPI('reset');
            
            // UI ì´ˆê¸°í™”
            sessionId = null;
            currentStep = 'search';
            selectedProduct = null;
            selectedOption = null;
            orderData = {};

            document.getElementById('searchInput').value = '';
            hideElement('resultsSection');
            hideElement('orderSection');
            hideAllSteps();

            // í¼ ì´ˆê¸°í™”
            document.getElementById('receiverName').value = '';
            document.getElementById('address').value = '';
            document.getElementById('phoneNumber').value = '';
            document.getElementById('email').value = '';
            document.getElementById('quantityInput').value = 1;

            showAlert('ğŸ”„ ìƒˆë¡œìš´ ì£¼ë¬¸ì„ ì‹œì‘í•©ë‹ˆë‹¤!', 'success');
        }

        // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤ ê°œì„ 
        function showElement(id) {
            console.log('ìš”ì†Œ í‘œì‹œ:', id);
            const element = document.getElementById(id);
            if (element) {
                element.style.display = 'block';
                element.classList.remove('hidden');
                console.log(`${id} í‘œì‹œë¨`);
            } else {
                console.error(`ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ: ${id}`);
            }
        }

        function hideElement(id) {
            console.log('ìš”ì†Œ ìˆ¨ê¸°ê¸°:', id);
            const element = document.getElementById(id);
            if (element) {
                element.style.display = 'none';
                element.classList.add('hidden');
                console.log(`${id} ìˆ¨ê²¨ì§`);
            }
        }

        function hideAllSteps() {
            console.log('ëª¨ë“  ë‹¨ê³„ ìˆ¨ê¸°ê¸°');
            const steps = ['optionStep', 'quantityStep', 'infoStep', 'finalStep', 'completedStep'];
            steps.forEach(step => {
                const element = document.getElementById(step);
                if (element) {
                    element.style.display = 'none';
                    element.classList.add('hidden');
                }
            });
        }

        function showLoading(show) {
            if (show) {
                showElement('loading');
            } else {
                hideElement('loading');
            }
        }

        function showAlert(message, type) {
            console.log('ì•Œë¦¼ í‘œì‹œ:', message, type);
            
            // ê¸°ì¡´ ì•Œë¦¼ ì œê±°
            const existingAlert = document.querySelector('.temp-alert');
            if (existingAlert) {
                existingAlert.remove();
            }

            // ìƒˆ ì•Œë¦¼ ìƒì„±
            const alert = document.createElement('div');
            alert.className = `alert alert-${type} temp-alert`;
            alert.style.position = 'fixed';
            alert.style.top = '20px';
            alert.style.right = '20px';
            alert.style.zIndex = '10000';
            alert.style.maxWidth = '300px';
            alert.style.animation = 'slideIn 0.3s ease-out';
            alert.textContent = message;

            // ìŠ¬ë¼ì´ë“œ ì¸ ì• ë‹ˆë©”ì´ì…˜ CSS ì¶”ê°€
            if (!document.querySelector('#alert-animations')) {
                const style = document.createElement('style');
                style.id = 'alert-animations';
                style.textContent = `
                    @keyframes slideIn {
                        from { transform: translateX(100%); opacity: 0; }
                        to { transform: translateX(0); opacity: 1; }
                    }
                    @keyframes slideOut {
                        from { transform: translateX(0); opacity: 1; }
                        to { transform: translateX(100%); opacity: 0; }
                    }
                `;
                document.head.appendChild(style);
            }

            // 3ì´ˆ í›„ ì œê±°
            setTimeout(() => {
                if (alert.parentElement) {
                    alert.style.animation = 'slideOut 0.3s ease-out';
                    setTimeout(() => {
                        if (alert.parentElement) {
                            alert.remove();
                        }
                    }, 300);
                }
            }, 3000);

            // bodyì— ì¶”ê°€
            document.body.appendChild(alert);
        }
    </script>
</body>
</html>
