<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChatMall - AI Shopping Assistant</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(120deg, #f6f7f9, #dfe9f3);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            width: 100%;
            max-width: 800px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 15px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #1877f2, #42b883);
            color: white;
            padding: 20px;
            text-align: center;
            font-size: 24px;
            font-weight: bold;
        }

        .content {
            padding: 30px;
        }

        .search-section {
            margin-bottom: 30px;
        }

        .search-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 25px;
            font-size: 16px;
            outline: none;
            transition: border-color 0.3s ease;
        }

        .search-input:focus {
            border-color: #1877f2;
        }

        .search-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #1877f2, #42b883);
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 15px;
            transition: transform 0.2s ease;
        }

        .search-btn:hover {
            transform: translateY(-2px);
        }

        .search-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .results-section {
            display: none;
            margin-top: 30px;
        }

        .ai-message {
            background: #e7f3ff;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #1877f2;
        }

        .product-grid {
            display: grid;
            gap: 20px;
        }

        .product-card {
            border: 2px solid #eee;
            border-radius: 15px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .product-card:hover {
            border-color: #1877f2;
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }

        .product-card.selected {
            border-color: #42b883;
            background: #f0fff4;
        }

        .product-image {
            width: 120px;
            height: 120px;
            object-fit: cover;
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .product-name {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
        }

        .product-price {
            font-size: 16px;
            color: #1877f2;
            font-weight: bold;
        }

        .order-section {
            display: none;
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 15px;
        }

        .order-step {
            margin-bottom: 25px;
        }

        .step-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
        }

        .options-grid {
            display: grid;
            gap: 10px;
        }

        .option-item {
            padding: 12px 15px;
            background: white;
            border: 2px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .option-item:hover {
            border-color: #1877f2;
        }

        .option-item.selected {
            border-color: #42b883 !important;
            background: #e8f5e8 !important;
            color: #2d5a2d;
            font-weight: bold;
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(66, 184, 131, 0.3);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }

        .form-input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: #1877f2;
        }

        .quantity-input {
            width: 100px;
            text-align: center;
        }

        .price-summary {
            background: #e7f3ff;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .price-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .total-price {
            font-size: 18px;
            font-weight: bold;
            color: #1877f2;
            border-top: 2px solid #ddd;
            padding-top: 10px;
            margin-top: 10px;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 5px;
        }

        .btn-primary {
            background: #1877f2;
            color: white;
        }

        .btn-primary:hover {
            background: #166fe5;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #1877f2;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none !important;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 15px;
            }
            
            .content {
                padding: 20px;
            }
            
            .header {
                font-size: 20px;
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            üõçÔ∏è ChatMall AI Shopping Assistant
        </div>
        
        <div class="content">
            <!-- Í≤ÄÏÉâ ÏÑπÏÖò -->
            <div class="search-section">
                <input 
                    type="text" 
                    id="searchInput" 
                    class="search-input" 
                    placeholder="Ï∞æÍ≥† Ïã∂ÏùÄ ÏÉÅÌíàÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî (Ïòà: Î¨¥ÏÑ† Ïù¥Ïñ¥Ìè∞, Ïó¨Î¶Ñ ÏõêÌîºÏä§)"
                    onkeypress="handleEnterKey(event)"
                >
                <button id="searchBtn" class="search-btn" onclick="searchProducts()">
                    üîç AI ÏÉÅÌíà Í≤ÄÏÉâ
                </button>
            </div>

            <!-- Í≤ÄÏÉâ Í≤∞Í≥º ÏÑπÏÖò -->
            <div id="resultsSection" class="results-section">
                <div id="aiMessage" class="ai-message"></div>
                <div id="productGrid" class="product-grid"></div>
            </div>

            <!-- Ï£ºÎ¨∏ ÏÑπÏÖò -->
            <div id="orderSection" class="order-section">
                <!-- ÏòµÏÖò ÏÑ†ÌÉù -->
                <div id="optionStep" class="order-step hidden">
                    <div class="step-title">‚öôÔ∏è ÏòµÏÖò ÏÑ†ÌÉù</div>
                    <div id="optionsGrid" class="options-grid"></div>
                    <button class="btn btn-primary" onclick="skipOptions()" id="skipOptionsBtn" style="display: none;">
                        ÏòµÏÖò ÏóÜÏù¥ ÏßÑÌñâ
                    </button>
                </div>

                <!-- ÏàòÎüâ ÏÑ†ÌÉù -->
                <div id="quantityStep" class="order-step hidden">
                    <div class="step-title">üî¢ ÏàòÎüâ ÏÑ†ÌÉù</div>
                    <div class="form-group">
                        <label class="form-label">ÏàòÎüâ:</label>
                        <input type="number" id="quantityInput" class="form-input quantity-input" value="1" min="1" onchange="calculatePrice()">
                        <div id="quantityInfo" style="margin-top: 10px; color: #666; font-size: 14px;"></div>
                    </div>
                    <div id="priceSummary" class="price-summary"></div>
                    <button class="btn btn-primary" onclick="confirmQuantity()">Ï£ºÎ¨∏ Ï†ïÎ≥¥ ÏûÖÎ†•ÌïòÍ∏∞</button>
                </div>

                <!-- Ï£ºÎ¨∏Ïûê Ï†ïÎ≥¥ -->
                <div id="infoStep" class="order-step hidden">
                    <div class="step-title">üìù Ï£ºÎ¨∏Ïûê Ï†ïÎ≥¥</div>
                    <div class="form-group">
                        <label class="form-label">ÏàòÎ†πÏù∏ Ïù¥Î¶Ñ:</label>
                        <input type="text" id="receiverName" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Î∞∞ÏÜ° Ï£ºÏÜå:</label>
                        <textarea id="address" class="form-input" rows="3" required></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Ïó∞ÎùΩÏ≤ò:</label>
                        <input type="tel" id="phoneNumber" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Ïù¥Î©îÏùº:</label>
                        <input type="email" id="email" class="form-input" required>
                    </div>
                    <button class="btn btn-success" onclick="submitOrderInfo()">Ï£ºÎ¨∏ ÌôïÏù∏ÌïòÍ∏∞</button>
                </div>

                <!-- ÏµúÏ¢Ö ÌôïÏù∏ -->
                <div id="finalStep" class="order-step hidden">
                    <div class="step-title">‚úÖ ÏµúÏ¢Ö Ï£ºÎ¨∏ ÌôïÏù∏</div>
                    <div id="finalSummary"></div>
                    <div class="alert alert-success">
                        <strong>üí≥ Í≤∞Ï†ú ÏïàÎÇ¥:</strong><br>
                        ÌïòÎÇòÏùÄÌñâ 841-910015-85404 (Ï£º)ÎÇòÎ°úÏàò<br>
                        ÏûÖÍ∏à ÌõÑ ÏïÑÎûò Î≤ÑÌäºÏùÑ ÌÅ¥Î¶≠Ìï¥Ï£ºÏÑ∏Ïöî.
                    </div>
                    <button class="btn btn-success" onclick="completeOrder()">üéâ Ï£ºÎ¨∏ ÏôÑÎ£å</button>
                </div>

                <!-- ÏôÑÎ£å -->
                <div id="completedStep" class="order-step hidden">
                    <div class="step-title">üéâ Ï£ºÎ¨∏ ÏôÑÎ£å</div>
                    <div id="completionMessage"></div>
                    <button class="btn btn-primary" onclick="startNewOrder()">ÏÉà Ï£ºÎ¨∏ ÏãúÏûë</button>
                </div>
            </div>

            <!-- Î°úÎî© -->
            <div id="loading" class="loading hidden">
                <div class="spinner"></div>
                <div>Ï≤òÎ¶¨ Ï§ëÏûÖÎãàÎã§...</div>
            </div>
        </div>
    </div>

    <script>
        // Ï†ÑÏó≠ Î≥ÄÏàò
        let sessionId = null;
        let currentStep = 'search';
        let selectedProduct = null;
        let selectedOption = null;
        let orderData = {};

        // ÏÑúÎ≤Ñ Ìò∏Ïä§Ìä∏
        const getHost = () => {
            return window.location.hostname === "localhost"
                ? "http://localhost:5051"
                : "https://port-0-chatmall2-mddsxz1wc930914e.sel5.cloudtype.app";
        };

        // ÌÜµÌï© API Ìò∏Ï∂ú
        async function callAPI(action, data = {}) {
            try {
                const response = await fetch(`${getHost()}/web/order`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: action,
                        session_id: sessionId,
                        ...data
                    })
                });

                const result = await response.json();
                
                if (result.session_id) {
                    sessionId = result.session_id;
                }

                return result;
            } catch (error) {
                console.error('API Ìò∏Ï∂ú Ïò§Î•ò:', error);
                return { success: false, error: 'ÏÑúÎ≤Ñ Ïó∞Í≤∞ Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.' };
            }
        }

        // ÏóîÌÑ∞ ÌÇ§ Ïù¥Î≤§Ìä∏
        function handleEnterKey(event) {
            if (event.key === 'Enter') {
                searchProducts();
            }
        }

        // ÏÉÅÌíà Í≤ÄÏÉâ
        async function searchProducts() {
            const query = document.getElementById('searchInput').value.trim();
            if (!query) {
                alert('Í≤ÄÏÉâÏñ¥Î•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî!');
                return;
            }

            showLoading(true);
            hideElement('resultsSection');
            hideElement('orderSection');

            const result = await callAPI('search', { query: query });

            showLoading(false);

            if (result.success) {
                displaySearchResults(result);
            } else {
                showAlert(result.error || 'Í≤ÄÏÉâ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', 'error');
            }
        }

        // Í≤ÄÏÉâ Í≤∞Í≥º ÌëúÏãú
        function displaySearchResults(result) {
            console.log('Í≤ÄÏÉâ Í≤∞Í≥º ÌëúÏãú:', result);
            
            if (result.message) {
                document.getElementById('aiMessage').textContent = result.message;
            }

            const productGrid = document.getElementById('productGrid');
            productGrid.innerHTML = '';

            if (result.results && result.results.length > 0) {
                result.results.forEach((product, index) => {
                    console.log(`ÏÉÅÌíà ${index + 1}:`, product);
                    
                    const productCard = document.createElement('div');
                    productCard.className = 'product-card';
                    productCard.onclick = () => selectProduct(product.ÏÉÅÌíàÏΩîÎìú, index);
                    
                    productCard.innerHTML = `
                        <div class="product-name">${product.Ï†úÎ™©}</div>
                        <div class="product-price">üí∞ ${parseInt(product.Í∞ÄÍ≤©).toLocaleString()}Ïõê</div>
                        <div style="color: #666; margin-top: 5px;">üöö Î∞∞ÏÜ°ÎπÑ: ${parseInt(product.Î∞∞ÏÜ°ÎπÑ).toLocaleString()}Ïõê</div>
                        <div style="color: #666;">üåç ÏõêÏÇ∞ÏßÄ: ${product.ÏõêÏÇ∞ÏßÄ}</div>
                        ${product.Ïù¥ÎØ∏ÏßÄ ? `<img src="${product.Ïù¥ÎØ∏ÏßÄ}" alt="ÏÉÅÌíà Ïù¥ÎØ∏ÏßÄ" class="product-image">` : ''}
                        <button class="btn btn-primary" style="margin-top: 15px; width: 100%;">Ïù¥ ÏÉÅÌíà Ï£ºÎ¨∏ÌïòÍ∏∞</button>
                    `;
                    
                    productGrid.appendChild(productCard);
                });

                // Í≤∞Í≥º ÏÑπÏÖò Í∞ïÏ†ú ÌëúÏãú
                const resultsSection = document.getElementById('resultsSection');
                resultsSection.style.display = 'block';
                resultsSection.classList.remove('hidden');
                console.log('Í≤ÄÏÉâ Í≤∞Í≥º ÏÑπÏÖò ÌëúÏãúÎê®');
            } else {
                document.getElementById('aiMessage').textContent = 'Í≤ÄÏÉâ Í≤∞Í≥ºÍ∞Ä ÏóÜÏäµÎãàÎã§. Îã§Î•∏ ÌÇ§ÏõåÎìúÎ°ú ÏãúÎèÑÌï¥Î≥¥ÏÑ∏Ïöî.';
                const resultsSection = document.getElementById('resultsSection');
                resultsSection.style.display = 'block';
                resultsSection.classList.remove('hidden');
            }
        }

        // ÏÉÅÌíà ÏÑ†ÌÉù
        async function selectProduct(productCode, index) {
            console.log('ÏÉÅÌíà ÏÑ†ÌÉù:', productCode, 'index:', index);
            showLoading(true);

            // ÏãúÍ∞ÅÏ†Å ÏÑ†ÌÉù ÌëúÏãú
            document.querySelectorAll('.product-card').forEach(card => {
                card.classList.remove('selected');
            });
            if (document.querySelectorAll('.product-card')[index]) {
                document.querySelectorAll('.product-card')[index].classList.add('selected');
            }

            const result = await callAPI('select_product', { product_code: productCode });
            console.log('üîç ÏÉÅÌíà ÏÑ†ÌÉù API Ï†ÑÏ≤¥ ÏùëÎãµ:', result);

            showLoading(false);

            if (result.success) {
                selectedProduct = result.product;
                console.log('‚úÖ ÏÑ†ÌÉùÎêú ÏÉÅÌíà:', selectedProduct);
                
                // ÎîîÎ≤ÑÍ∑∏ Ï†ïÎ≥¥ Ï∂úÎ†•
                if (result.debug_info) {
                    console.log('üêõ ÎîîÎ≤ÑÍ∑∏ Ï†ïÎ≥¥:');
                    console.log('   - ÏõêÎ≥∏ ÏòµÏÖò Îç∞Ïù¥ÌÑ∞:', result.debug_info.raw_options);
                    console.log('   - ÌååÏã±Îêú ÏòµÏÖò Ïàò:', result.debug_info.parsed_count);
                }
                
                console.log('üìã Î∞õÏùÄ ÏòµÏÖò Î™©Î°ù:', result.options);
                console.log('üìä ÏòµÏÖò Í∞úÏàò:', result.options ? result.options.length : 0);
                console.log('üîç ÏòµÏÖò ÏûàÏùå Ïó¨Î∂Ä:', result.has_options);
                
                // Ï£ºÎ¨∏ ÏÑπÏÖò Í∞ïÏ†ú ÌëúÏãú
                const orderSection = document.getElementById('orderSection');
                orderSection.style.display = 'block';
                orderSection.classList.remove('hidden');
                console.log('Ï£ºÎ¨∏ ÏÑπÏÖò ÌëúÏãúÎê®');

                if (result.has_options && result.options && result.options.length > 0) {
                    console.log('‚úÖ ÏòµÏÖòÏù¥ ÏûàÏñ¥ÏÑú ÏòµÏÖò ÌëúÏãú Ìï®Ïàò Ìò∏Ï∂ú');
                    displayOptions(result.options);
                } else {
                    console.log('‚ö†Ô∏è ÏòµÏÖòÏù¥ ÏóÜÏñ¥ÏÑú Î∞îÎ°ú ÏàòÎüâ ÏÑ†ÌÉùÏúºÎ°ú');
                    skipOptions();
                }
            } else {
                console.error('‚ùå ÏÉÅÌíà ÏÑ†ÌÉù Ïã§Ìå®:', result.error);
                showAlert(result.error || 'ÏÉÅÌíà ÏÑ†ÌÉù Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', 'error');
            }
        }

        // ÏòµÏÖò ÌëúÏãú
        function displayOptions(options) {
            console.log('üéØ ÏòµÏÖò ÌëúÏãú Ìï®Ïàò ÏãúÏûë');
            console.log('üìã Î∞õÏùÄ ÏòµÏÖò Î∞∞Ïó¥:', options);
            console.log('üìä ÏòµÏÖò Î∞∞Ïó¥ Í∏∏Ïù¥:', options.length);
            
            // Í∞Å ÏòµÏÖò ÏÉÅÏÑ∏ Ï∂úÎ†•
            options.forEach((option, index) => {
                console.log(`   ÏòµÏÖò ${index + 1}:`, option);
                console.log(`     - Ïù¥Î¶Ñ: ${option.name}`);
                console.log(`     - Ï∂îÍ∞ÄÍ∏àÏï°: ${option.extra_price}`);
                console.log(`     - ÌëúÏãúÎ™Ö: ${option.display}`);
            });
            
            const optionsGrid = document.getElementById('optionsGrid');
            console.log('üîç ÏòµÏÖò Í∑∏Î¶¨Îìú ÏöîÏÜå:', optionsGrid);
            
            // Í∏∞Ï°¥ ÏòµÏÖò Ï†úÍ±∞
            optionsGrid.innerHTML = '';
            console.log('üßπ Í∏∞Ï°¥ ÏòµÏÖò Ï†úÍ±∞ ÏôÑÎ£å');

            // Í∞Å ÏòµÏÖòÏùÑ DOMÏóê Ï∂îÍ∞Ä
            options.forEach((option, index) => {
                console.log(`üî® ÏòµÏÖò ${index + 1} DOM ÏÉùÏÑ± Ï§ë: ${option.display}`);
                
                const optionItem = document.createElement('div');
                optionItem.className = 'option-item';
                optionItem.id = `option-${index}`;
                optionItem.textContent = option.display;
                
                // ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏ ÏÑ§Ï†ï
                optionItem.onclick = () => {
                    console.log(`üñ±Ô∏è ÏòµÏÖò ${index + 1} ÌÅ¥Î¶≠Îê®:`, option.name);
                    selectOption(option.name, option.extra_price, index);
                };
                
                // Ìò∏Î≤Ñ Ìö®Í≥º Ï∂îÍ∞Ä
                optionItem.addEventListener('mouseenter', function() {
                    console.log(`üñ±Ô∏è ÏòµÏÖò ${index + 1} ÎßàÏö∞Ïä§ ÏßÑÏûÖ`);
                    if (!this.classList.contains('selected')) {
                        this.style.borderColor = '#1877f2';
                        this.style.backgroundColor = '#f0f9ff';
                    }
                });
                
                optionItem.addEventListener('mouseleave', function() {
                    if (!this.classList.contains('selected')) {
                        this.style.borderColor = '#ddd';
                        this.style.backgroundColor = 'white';
                    }
                });
                
                optionsGrid.appendChild(optionItem);
                console.log(`‚úÖ ÏòµÏÖò ${index + 1} DOM Ï∂îÍ∞Ä ÏôÑÎ£å`);
            });

            console.log('üéØ ÏòµÏÖò Í∑∏Î¶¨ÎìúÏóê Ï∂îÍ∞ÄÎêú Ï¥ù ÏòµÏÖò Ïàò:', optionsGrid.children.length);

            // ÏòµÏÖò Îã®Í≥Ñ Í∞ïÏ†ú ÌëúÏãú
            const optionStep = document.getElementById('optionStep');
            optionStep.style.display = 'block';
            optionStep.classList.remove('hidden');
            
            const skipBtn = document.getElementById('skipOptionsBtn');
            skipBtn.style.display = 'block';
            
            console.log('‚úÖ ÏòµÏÖò Îã®Í≥Ñ UI ÌëúÏãú ÏôÑÎ£å');
            console.log('üìä ÏµúÏ¢Ö ÏÉÅÌÉú:');
            console.log('   - ÏòµÏÖò Îã®Í≥Ñ ÌëúÏãúÎê®:', !optionStep.classList.contains('hidden'));
            console.log('   - ÏòµÏÖò Ìï≠Î™© Ïàò:', optionsGrid.children.length);
            console.log('   - Í±¥ÎÑàÎõ∞Í∏∞ Î≤ÑÌäº ÌëúÏãú:', skipBtn.style.display === 'block');
        }

        // ÏòµÏÖò ÏÑ†ÌÉù
        async function selectOption(optionName, extraPrice, index) {
            console.log('ÏòµÏÖò ÏÑ†ÌÉù:', optionName, extraPrice, index);
            
            // ÏãúÍ∞ÅÏ†Å ÏÑ†ÌÉù ÌëúÏãú
            document.querySelectorAll('.option-item').forEach(item => {
                item.classList.remove('selected');
            });
            
            const optionItems = document.querySelectorAll('.option-item');
            if (optionItems[index]) {
                optionItems[index].classList.add('selected');
                console.log('ÏòµÏÖò ÏãúÍ∞ÅÏ†Å ÏÑ†ÌÉù ÏôÑÎ£å');
            }

            // API Ìò∏Ï∂ú
            const result = await callAPI('select_option', {
                option_name: optionName,
                extra_price: extraPrice
            });

            console.log('ÏòµÏÖò ÏÑ†ÌÉù API Í≤∞Í≥º:', result);

            if (result.success) {
                selectedOption = { name: optionName, extra_price: extraPrice };
                console.log('ÏòµÏÖò ÏÑ†ÌÉù ÏÑ±Í≥µ, 1.5Ï¥à ÌõÑ ÏàòÎüâ Îã®Í≥ÑÎ°ú Ïù¥Îèô');
                
                // ÏÑ†ÌÉù ÏôÑÎ£å Î©îÏãúÏßÄ ÌëúÏãú
                showAlert(`‚úÖ ÏòµÏÖò ÏÑ†ÌÉù ÏôÑÎ£å: ${optionName}`, 'success');
                
                setTimeout(() => {
                    console.log('ÏòµÏÖò Îã®Í≥Ñ Ïà®Í∏∞Í∏∞');
                    // ÏòµÏÖò Îã®Í≥Ñ Ïà®Í∏∞Í∏∞
                    const optionStep = document.getElementById('optionStep');
                    optionStep.style.display = 'none';
                    optionStep.classList.add('hidden');
                    
                    console.log('ÏàòÎüâ Îã®Í≥Ñ ÌëúÏãú ÏãúÏûë');
                    showQuantityStep();
                }, 1500);
            } else {
                console.error('ÏòµÏÖò ÏÑ†ÌÉù Ïã§Ìå®:', result.error);
                showAlert(result.error || 'ÏòµÏÖò ÏÑ†ÌÉù Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', 'error');
            }
        }

        // ÏòµÏÖò Í±¥ÎÑàÎõ∞Í∏∞
        async function skipOptions() {
            console.log('ÏòµÏÖò Í±¥ÎÑàÎõ∞Í∏∞');
            
            // Í∏∞Î≥∏ ÏòµÏÖòÏúºÎ°ú ÏÑ§Ï†ï
            const result = await callAPI('select_option', {
                option_name: 'Í∏∞Î≥∏ÏòµÏÖò',
                extra_price: 0
            });

            if (result.success) {
                selectedOption = { name: 'Í∏∞Î≥∏ÏòµÏÖò', extra_price: 0 };
                console.log('Í∏∞Î≥∏ ÏòµÏÖò ÏÑ§Ï†ï ÏôÑÎ£å');
                
                // ÏòµÏÖò Îã®Í≥Ñ Ïà®Í∏∞Í∏∞
                const optionStep = document.getElementById('optionStep');
                optionStep.style.display = 'none';
                optionStep.classList.add('hidden');
                
                showQuantityStep();
            } else {
                // API Ïã§Ìå®ÏãúÏóêÎèÑ ÏßÑÌñâ (ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏ÏóêÏÑúÎßå Ï≤òÎ¶¨)
                selectedOption = { name: 'Í∏∞Î≥∏ÏòµÏÖò', extra_price: 0 };
                console.log('API Ïã§Ìå®ÌñàÏßÄÎßå Í∏∞Î≥∏ ÏòµÏÖòÏúºÎ°ú ÏßÑÌñâ');
                
                const optionStep = document.getElementById('optionStep');
                optionStep.style.display = 'none';
                optionStep.classList.add('hidden');
                
                showQuantityStep();
            }
        }

        // ÏàòÎüâ ÏÑ†ÌÉù Îã®Í≥Ñ ÌëúÏãú
        function showQuantityStep() {
            console.log('ÏàòÎüâ ÏÑ†ÌÉù Îã®Í≥Ñ ÌëúÏãú');
            
            // ÏàòÎüâ Îã®Í≥Ñ Í∞ïÏ†ú ÌëúÏãú
            const quantityStep = document.getElementById('quantityStep');
            quantityStep.style.display = 'block';
            quantityStep.classList.remove('hidden');
            
            console.log('ÏàòÎüâ Îã®Í≥Ñ ÌëúÏãúÎê®');
            calculatePrice();
        }

        // Í∞ÄÍ≤© Í≥ÑÏÇ∞
        async function calculatePrice() {
            const quantity = parseInt(document.getElementById('quantityInput').value) || 1;

            const result = await callAPI('set_quantity', { quantity: quantity });

            if (result.success) {
                const summary = result.order_summary;

                // ÏàòÎüâ Ï†ïÎ≥¥ ÌëúÏãú
                let quantityInfo = `üì¶ Ï£ºÎ¨∏ ÏàòÎüâ: ${quantity}Í∞ú`;
                if (summary.bundle_size > 0 && summary.bundles_needed > 1) {
                    quantityInfo += `<br>üì¶ Î¨∂ÏùåÎ∞∞ÏÜ°: ${summary.bundle_size}Í∞úÏî© √ó ${summary.bundles_needed}Î¨∂Ïùå`;
                }
                document.getElementById('quantityInfo').innerHTML = quantityInfo;

                // Í∞ÄÍ≤© ÏöîÏïΩ ÌëúÏãú
                const priceSummary = document.getElementById('priceSummary');
                priceSummary.innerHTML = `
                    <div class="price-row">
                        <span>ÏÉÅÌíà Îã®Í∞Ä:</span>
                        <span>${summary.unit_price.toLocaleString()}Ïõê</span>
                    </div>
                    ${summary.extra_price > 0 ? `
                    <div class="price-row">
                        <span>ÏòµÏÖò Ï∂îÍ∞Ä:</span>
                        <span>+${summary.extra_price.toLocaleString()}Ïõê</span>
                    </div>` : ''}
                    <div class="price-row">
                        <span>ÏÉÅÌíà ÏÜåÍ≥Ñ:</span>
                        <span>${summary.item_total.toLocaleString()}Ïõê</span>
                    </div>
                    <div class="price-row">
                        <span>Î∞∞ÏÜ°ÎπÑ:</span>
                        <span>${summary.shipping_fee.toLocaleString()}Ïõê</span>
                    </div>
                    <div class="price-row total-price">
                        <span>Ï¥ù Í≤∞Ï†úÍ∏àÏï°:</span>
                        <span>${summary.total_price.toLocaleString()}Ïõê</span>
                    </div>
                `;

                orderData = summary;
            }
        }

        // ÏàòÎüâ ÌôïÏù∏
        function confirmQuantity() {
            const quantity = parseInt(document.getElementById('quantityInput').value);
            if (!quantity || quantity < 1) {
                alert('Ïò¨Î∞îÎ•∏ ÏàòÎüâÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }

            console.log('ÏàòÎüâ ÌôïÏù∏Îê®, Ï†ïÎ≥¥ ÏûÖÎ†• Îã®Í≥ÑÎ°ú Ïù¥Îèô');
            
            // ÏàòÎüâ Îã®Í≥Ñ Ïà®Í∏∞Í∏∞
            const quantityStep = document.getElementById('quantityStep');
            quantityStep.style.display = 'none';
            quantityStep.classList.add('hidden');
            
            // Ï†ïÎ≥¥ ÏûÖÎ†• Îã®Í≥Ñ ÌëúÏãú
            const infoStep = document.getElementById('infoStep');
            infoStep.style.display = 'block';
            infoStep.classList.remove('hidden');
            
            console.log('Ï†ïÎ≥¥ ÏûÖÎ†• Îã®Í≥Ñ ÌëúÏãúÎê®');
        }

        // Ï£ºÎ¨∏Ïûê Ï†ïÎ≥¥ Ï†úÏ∂ú
        async function submitOrderInfo() {
            const receiverName = document.getElementById('receiverName').value.trim();
            const address = document.getElementById('address').value.trim();
            const phoneNumber = document.getElementById('phoneNumber').value.trim();
            const email = document.getElementById('email').value.trim();

            if (!receiverName || !address || !phoneNumber || !email) {
                alert('Î™®Îì† ÌïÑÏàò Ï†ïÎ≥¥Î•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }

            console.log('Ï£ºÎ¨∏Ïûê Ï†ïÎ≥¥ Ï†úÏ∂ú');
            showLoading(true);

            const result = await callAPI('submit_info', {
                receiver_name: receiverName,
                address: address,
                phone_number: phoneNumber,
                email: email
            });

            console.log('Ï£ºÎ¨∏Ïûê Ï†ïÎ≥¥ Ï†úÏ∂ú Í≤∞Í≥º:', result);
            showLoading(false);

            if (result.success) {
                // Ï†ïÎ≥¥ ÏûÖÎ†• Îã®Í≥Ñ Ïà®Í∏∞Í∏∞
                const infoStep = document.getElementById('infoStep');
                infoStep.style.display = 'none';
                infoStep.classList.add('hidden');
                
                console.log('Ï†ïÎ≥¥ ÏûÖÎ†• ÏôÑÎ£å, ÏµúÏ¢Ö ÏöîÏïΩÏúºÎ°ú Ïù¥Îèô');
                showFinalSummary();
            } else {
                showAlert(result.error || 'Ï£ºÎ¨∏ Ï†ïÎ≥¥ Ï†ÄÏû• Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', 'error');
            }
        }

        // ÏµúÏ¢Ö ÏöîÏïΩ ÌëúÏãú
        function showFinalSummary() {
            console.log('ÏµúÏ¢Ö ÏöîÏïΩ ÌëúÏãú');
            
            const receiverName = document.getElementById('receiverName').value;
            const address = document.getElementById('address').value;

            document.getElementById('finalSummary').innerHTML = `
                <div class="alert alert-success">
                    <strong>üìã Ï£ºÎ¨∏ ÏµúÏ¢Ö ÌôïÏù∏:</strong><br><br>
                    <strong>üë§ ÏàòÎ†πÏù∏:</strong> ${receiverName}<br>
                    <strong>üì¶ ÏÉÅÌíà:</strong> ${selectedProduct.name}<br>
                    <strong>‚öôÔ∏è ÏòµÏÖò:</strong> ${selectedOption.name}<br>
                    <strong>üî¢ ÏàòÎüâ:</strong> ${orderData.quantity}Í∞ú<br>
                    <strong>üè† Î∞∞ÏÜ°ÏßÄ:</strong> ${address}<br><br>
                    <div class="total-price">
                        üí∞ Ï¥ù Í≤∞Ï†úÍ∏àÏï°: ${orderData.total_price.toLocaleString()}Ïõê
                    </div>
                </div>
            `;

            // ÏµúÏ¢Ö Îã®Í≥Ñ Í∞ïÏ†ú ÌëúÏãú
            const finalStep = document.getElementById('finalStep');
            finalStep.style.display = 'block';
            finalStep.classList.remove('hidden');
            
            console.log('ÏµúÏ¢Ö Îã®Í≥Ñ ÌëúÏãúÎê®');
        }

        // Ï£ºÎ¨∏ ÏôÑÎ£å
        async function completeOrder() {
            console.log('Ï£ºÎ¨∏ ÏôÑÎ£å Ï≤òÎ¶¨ ÏãúÏûë');
            showLoading(true);

            const result = await callAPI('complete');
            console.log('Ï£ºÎ¨∏ ÏôÑÎ£å Í≤∞Í≥º:', result);

            showLoading(false);

            if (result.success) {
                // ÏµúÏ¢Ö Îã®Í≥Ñ Ïà®Í∏∞Í∏∞
                const finalStep = document.getElementById('finalStep');
                finalStep.style.display = 'none';
                finalStep.classList.add('hidden');
                
                document.getElementById('completionMessage').innerHTML = `
                    <div class="alert alert-success">
                        <strong>üéâ Ï£ºÎ¨∏Ïù¥ ÏÑ±Í≥µÏ†ÅÏúºÎ°ú ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§!</strong><br><br>
                        <strong>üìã Ï£ºÎ¨∏Î≤àÌò∏:</strong> ${result.order_number}<br>
                        <strong>‚è∞ Ï£ºÎ¨∏ÏãúÍ∞Ñ:</strong> ${result.order_details.timestamp}<br>
                        <strong>üí∞ Í≤∞Ï†úÍ∏àÏï°:</strong> ${result.order_details.total_price.toLocaleString()}Ïõê<br><br>
                        üí≥ ÏûÖÍ∏à ÌôïÏù∏ ÌõÑ ÏÉÅÌíà Ï§ÄÎπÑÏóê Îì§Ïñ¥Í∞ëÎãàÎã§.</p>
                    </div>
                `;

                // ÏôÑÎ£å Îã®Í≥Ñ ÌëúÏãú
                const completedStep = document.getElementById('completedStep');
                completedStep.style.display = 'block';
                completedStep.classList.remove('hidden');
                
                console.log('Ï£ºÎ¨∏ ÏôÑÎ£å Îã®Í≥Ñ ÌëúÏãúÎê®');
            } else {
                showAlert(result.error || 'Ï£ºÎ¨∏ ÏôÑÎ£å Ï≤òÎ¶¨ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', 'error');
            }
        }

        // ÏÉà Ï£ºÎ¨∏ ÏãúÏûë
        async function startNewOrder() {
            await callAPI('reset');
            
            // UI Ï¥àÍ∏∞Ìôî
            sessionId = null;
            currentStep = 'search';
            selectedProduct = null;
            selectedOption = null;
            orderData = {};

            document.getElementById('searchInput').value = '';
            hideElement('resultsSection');
            hideElement('orderSection');
            hideAllSteps();

            // Ìèº Ï¥àÍ∏∞Ìôî
            document.getElementById('receiverName').value = '';
            document.getElementById('address').value = '';
            document.getElementById('phoneNumber').value = '';
            document.getElementById('email').value = '';
            document.getElementById('quantityInput').value = 1;

            showAlert('üîÑ ÏÉàÎ°úÏö¥ Ï£ºÎ¨∏ÏùÑ ÏãúÏûëÌï©ÎãàÎã§!', 'success');
        }

        // Ïú†Ìã∏Î¶¨Ìã∞ Ìï®ÏàòÎì§ Í∞úÏÑ†
        function showElement(id) {
            console.log('ÏöîÏÜå ÌëúÏãú:', id);
            const element = document.getElementById(id);
            if (element) {
                element.style.display = 'block';
                element.classList.remove('hidden');
                console.log(`${id} ÌëúÏãúÎê®`);
            } else {
                console.error(`ÏöîÏÜåÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏùå: ${id}`);
            }
        }

        function hideElement(id) {
            console.log('ÏöîÏÜå Ïà®Í∏∞Í∏∞:', id);
            const element = document.getElementById(id);
            if (element) {
                element.style.display = 'none';
                element.classList.add('hidden');
                console.log(`${id} Ïà®Í≤®Ïßê`);
            }
        }

        function hideAllSteps() {
            console.log('Î™®Îì† Îã®Í≥Ñ Ïà®Í∏∞Í∏∞');
            const steps = ['optionStep', 'quantityStep', 'infoStep', 'finalStep', 'completedStep'];
            steps.forEach(step => {
                const element = document.getElementById(step);
                if (element) {
                    element.style.display = 'none';
                    element.classList.add('hidden');
                }
            });
        }

        function showLoading(show) {
            if (show) {
                showElement('loading');
            } else {
                hideElement('loading');
            }
        }

        function showAlert(message, type) {
            console.log('ÏïåÎ¶º ÌëúÏãú:', message, type);
            
            // Í∏∞Ï°¥ ÏïåÎ¶º Ï†úÍ±∞
            const existingAlert = document.querySelector('.temp-alert');
            if (existingAlert) {
                existingAlert.remove();
            }

            // ÏÉà ÏïåÎ¶º ÏÉùÏÑ±
            const alert = document.createElement('div');
            alert.className = `alert alert-${type} temp-alert`;
            alert.style.position = 'fixed';
            alert.style.top = '20px';
            alert.style.right = '20px';
            alert.style.zIndex = '10000';
            alert.style.maxWidth = '300px';
            alert.style.animation = 'slideIn 0.3s ease-out';
            alert.textContent = message;

            // Ïä¨ÎùºÏù¥Îìú Ïù∏ Ïï†ÎãàÎ©îÏù¥ÏÖò CSS Ï∂îÍ∞Ä
            if (!document.querySelector('#alert-animations')) {
                const style = document.createElement('style');
                style.id = 'alert-animations';
                style.textContent = `
                    @keyframes slideIn {
                        from { transform: translateX(100%); opacity: 0; }
                        to { transform: translateX(0); opacity: 1; }
                    }
                    @keyframes slideOut {
                        from { transform: translateX(0); opacity: 1; }
                        to { transform: translateX(100%); opacity: 0; }
                    }
                `;
                document.head.appendChild(style);
            }

            // 3Ï¥à ÌõÑ Ï†úÍ±∞
            setTimeout(() => {
                if (alert.parentElement) {
                    alert.style.animation = 'slideOut 0.3s ease-out';
                    setTimeout(() => {
                        if (alert.parentElement) {
                            alert.remove();
                        }
                    }, 300);
                }
            }, 3000);

            // bodyÏóê Ï∂îÍ∞Ä
            document.body.appendChild(alert);
        }
    </script>
</body>
</html>
